

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<title>Dealing with Multiple Varnishes &mdash; Varnish Wiki  documentation</title>
	

	
	

	

	<script type="text/javascript">
		var DOCUMENTATION_OPTIONS = {
			URL_ROOT:       './',
			VERSION:        '1.0',
			COLLAPSE_INDEX: false,
			FILE_SUFFIX:    '.html',
			HAS_SOURCE:     true
		};
	</script>
	<script type="text/javascript" src="https://www.varnish-software.com//wiki/_static/jquery.js"></script>
	<script type="text/javascript" src="https://www.varnish-software.com//wiki/_static/underscore.js"></script>
	<script type="text/javascript" src="https://www.varnish-software.com//wiki/_static/doctools.js"></script>
	<script type="text/javascript" src="https://www.varnish-software.com//wiki/_static/searchtools.js"></script>
	<script type="text/javascript" src="https://www.varnish-software.com//wiki/_static/js/jquery-1.11.0.min.js"></script>
	<script type="text/javascript" src="https://www.varnish-software.com//wiki/_static/js/jquery-fix.js"></script>
	<link rel="search" title="Search" href="#" />
	<script type="text/javascript">jQuery(function() { Search.loadIndex("searchindex.js"); });</script>
	<script type="text/javascript" id="searchindexloader"></script>
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-15491050-1']);
		_gaq.push(['_trackPageview']);
		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>

	<link rel="stylesheet" href="../../../_static/default.css"/>
	<link rel="stylesheet" href="../../../_static/custom.css"/>

	<script src="../../../_static/js/popper.min.js"></script>
	<script src="../../../_static/js/bootstrap.min.js"></script>
	<link href="../../../_static/css/bootstrap.min.css" rel="stylesheet">
	<link href="../../../_static/css/font-awesome.min.css" rel="stylesheet">
	<link href="../../../_static/css/custom.css" rel="stylesheet">
	<link href="../../../_static/css/prism.css" rel="stylesheet">
	<link rel="icon" type="image/png" href="../../../_static/images/favicon.png">

	
	<script src="../../../_static/js/modernizr.min.js"></script></head>
<body>

<div class="container">
	<a href="https://www.varnish-software.com/">
		<img class="logo" src="../../../_static/images/varnish_software_logo.png" />
	</a>

	<hr />
</div>
<div class="container">

	

	<div id="wiki-sidebar">
		<div class="sidebar-block">
			<div class="sidebar-wrapper">
				<h3>Contents</h3>
			<div class="sidebar-localtoc">
				<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../start/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/index.html">Varnish Web Developer&#8217;s FAQ</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">How to Varnish</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="builtin_vcl.html">What&#8217;s in the Builtin VCL?</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Dealing with Multiple Varnishes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#having-multiple-backends">Having Multiple backends</a></li>
<li class="toctree-l3"><a class="reference internal" href="#backends-and-virtual-hosts-in-varnish">Backends and Virtual Hosts in Varnish</a></li>
<li class="toctree-l3"><a class="reference internal" href="#directors">Directors</a></li>
<li class="toctree-l3"><a class="reference internal" href="#health-checks">Health Checks</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="run_varnish.html">Lets Run Varnish!</a></li>
<li class="toctree-l2"><a class="reference internal" href="sample_vclTemplate.html">Sample VCLs</a></li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting_varnish.html">Troubleshooting Varnish</a></li>
<li class="toctree-l2"><a class="reference internal" href="varnish_ubuntu.html">Installing and Configuring Varnish</a></li>
<li class="toctree-l2"><a class="reference internal" href="varnish_test.html">Testing with VarnishTest</a></li>
<li class="toctree-l2"><a class="reference internal" href="varnishCacheVersions.html">Which version of Varnish to use?</a></li>
<li class="toctree-l2"><a class="reference internal" href="vcl.html">Varnish Configuration Language (VCL)</a></li>
<li class="toctree-l2"><a class="reference internal" href="vcl_examples.html">Cache Invalidation with Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#installing-varnish-with-binary-packages"><strong>Installing Varnish with Binary Packages</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#choosing-os">Choosing OS</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#compiling-varnish-from-source"><strong>Compiling Varnish from source</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#building-varnish">Building Varnish</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../wordpress/index.html">WordPress with Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../magento2/index.html">Magento2 with Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../drupal/index.html">Drupal with Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aem.html">Adobe Experience Manager and Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../expressionEngine.html">ExpressionEngine and Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sitecoreCMS.html">Sitecore CMS and Varnish</a></li>
</ul>

			</div>
		</div>
	</div>

	
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="../../../search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
	
  <div class="sidebar-block">
    <div class="sidebar-wrapper">
      <h4>&nbsp;&nbsp;Contribute</h4>
      <ul class="this-page-menu">
        <li><a href="../../../_sources/content/tutorials/varnish/multiple_varnishes.txt"
               rel="nofollow">Show Source</a></li>
        <li><a href="https://github.com/huayra/wiki_varnish/blob/master/source/content/tutorials/varnish/multiple_varnishes.rst"
               rel="nofollow">Show on GitHub</a></li>
        <li><a href="https://github.com/huayra/wiki_varnish/edit/master/source/content/tutorials/varnish/multiple_varnishes.rst"
               rel="nofollow">Edit on GitHub</a></li>
      </ul>
    </div>
  </div>
</div>


<div id="wiki-content">
	
  <div class="section" id="dealing-with-multiple-varnishes">
<span id="multiple-varnishes"></span><h1>Dealing with Multiple Varnishes<a class="headerlink" href="#dealing-with-multiple-varnishes" title="Permalink to this headline">¶</a></h1>
<p>If you are considering or already have more than one Varnish cache.
You definitely have a huge network to <strong>manage!</strong></p>
<div class="section" id="having-multiple-backends">
<h2>Having Multiple backends<a class="headerlink" href="#having-multiple-backends" title="Permalink to this headline">¶</a></h2>
<p>Multiple backends means serving from several servers.
You want Varnish to map all the URL into one single host. There are lot of options.</p>
<p>Lets take a PHP Applciation website and you would like to add a Java application
into it.. Lets say your Java application should handle URL beginning with /java/.</p>
<p>Assuming that you already have a backend running at 8080 and serving content to
user through port 80. This is your default vcl:</p>
<div class="highlight-vcl"><div class="highlight"><pre><span></span><span class="k">backend</span><span class="vg"> default</span><span class="p"> {</span>
    <span class="na">.host</span><span class="o"> = </span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">;</span>
    <span class="na">.port</span><span class="o"> = </span><span class="s">&quot;8080&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now lets add a new backend:</p>
<div class="highlight-vcl"><div class="highlight"><pre><span></span><span class="k">backend</span><span class="vg"> java</span><span class="p"> {</span>
    <span class="na">.host</span><span class="o"> = </span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">;</span>
    <span class="na">.port</span><span class="o"> = </span><span class="s">&quot;8000&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now we need to tell Varnish where to send the different URL. here is what you
need in your <strong>vcl_recv</strong> :</p>
<div class="highlight-VCL"><div class="highlight"><pre><span></span><span class="k">sub </span><span class="nf">vcl_recv</span><span class="p"> {</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">req.url</span> <span class="o">~</span> <span class="s">&quot;^/java/&quot;</span><span class="p">)</span> <span class="o">{</span>
        <span class="k">set</span> <span class="nv">req.backend_hint</span> <span class="o">=</span> <span class="n">java</span><span class="p">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">set</span> <span class="nv">req.backend_hint</span> <span class="o">=</span> <span class="n">default</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>As you can see you can define how to choose backends based on really arbitrary data.
if you want to send mobile devices to a different backend, a little bit more of
VCl should do the trick.</p>
<div class="highlight-vcl"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nv">req.http.User-agent</span> <span class="o">~</span> <span class="o">/</span><span class="n">mobile</span><span class="o">/</span><span class="p">)</span>
<span class="o">..</span>
</pre></div>
</div>
<p>If there is no backend defined, varnish uses the default backend. If there is
no backend named default, varnish will use the first backend found in the vcl.</p>
</div>
<div class="section" id="backends-and-virtual-hosts-in-varnish">
<h2>Backends and Virtual Hosts in Varnish<a class="headerlink" href="#backends-and-virtual-hosts-in-varnish" title="Permalink to this headline">¶</a></h2>
<p>Varnish fully supports virtual hosts!</p>
<p>They might however work in a somewhat <em>counter-intuitive fashion</em> since they are
never declared explicitly. You have to set up the routing of incoming HTTP requests
in <cite>vcl_recv</cite>. If you want this routing to be done on the basis of virtual hosts,
you just need to inspect req.http.host.</p>
<p>You can have something like this:</p>
<div class="highlight-VCL"><div class="highlight"><pre><span></span><span class="k">sub </span><span class="nf">vcl_recv</span><span class="p"> {</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">req.http.host</span> <span class="o">~</span> <span class="s">&quot;foo.com&quot;</span><span class="p">)</span> <span class="o">{</span>
        <span class="k">set</span> <span class="nv">req.backend_hint</span> <span class="o">=</span> <span class="n">foo</span><span class="p">;</span>
    <span class="o">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">req.http.host</span> <span class="o">~</span> <span class="s">&quot;bar.com&quot;</span><span class="p">)</span> <span class="o">{</span>
        <span class="k">set</span> <span class="nv">req.backend_hint</span> <span class="o">=</span> <span class="n">bar</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Note that the first regular expressions will match &#8220;foo.com&#8221;, &#8220;www.foo.com&#8221;,
&#8220;zoop.foo.com&#8221; and any other host ending in &#8220;foo.com&#8221;.</p>
<p>In this example this is intentional but you might want it to be a bit more tight,
maybe relying on the <strong>==</strong> operator instead, like this:</p>
<div class="highlight-VCL"><div class="highlight"><pre><span></span>  <span class="k">sub </span><span class="nf">vcl_recv</span><span class="p"> {</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">req.http.host</span> <span class="o">==</span> <span class="s">&quot;foo.com&quot;</span> <span class="o">||</span> <span class="nv">req.http.host</span> <span class="o">==</span> <span class="s">&quot;www.foo.com&quot;</span><span class="p">)</span> <span class="o">{</span>
          <span class="k">set</span> <span class="nv">req.backend_hint</span> <span class="o">=</span> <span class="n">foo</span><span class="p">;</span>
      <span class="o">}</span>
  <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="directors">
<h2>Directors<a class="headerlink" href="#directors" title="Permalink to this headline">¶</a></h2>
<p>You can also group several backend into a group of backends.
These groups are called <strong>directors</strong>. This will give you increased performance
and resilience.</p>
<p>You can define several backends and group them together in a director.
This requires you to load a VMOD, a Varnish module, and then to call certain
actions in vcl_init.:</p>
<div class="highlight-VCL"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="n">directors</span><span class="p">;</span>    <span class="c"># load the directors</span>

<span class="k">backend</span><span class="vg"> server1</span><span class="p"> {</span>
    <span class="na">.host</span><span class="o"> = </span><span class="s">&quot;192.168.0.10&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">backend</span><span class="vg"> server2</span><span class="p"> {</span>
    <span class="na">.host</span><span class="o"> = </span><span class="s">&quot;192.168.0.10&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">vcl_init</span><span class="p"> {</span>
    <span class="k">new</span> <span class="n">bar</span> <span class="o">=</span> <span class="nf">directors</span><span class="p">.</span><span class="nf">round_robin</span><span class="p">();</span>
    <span class="nf">bar</span><span class="p">.</span><span class="nf">add_backend</span><span class="p">(</span><span class="n">server1</span><span class="p">);</span>
    <span class="nf">bar</span><span class="p">.</span><span class="nf">add_backend</span><span class="p">(</span><span class="n">server2</span><span class="p">);</span>
<span class="o">}</span>

<span class="k">sub </span><span class="nf">vcl_recv</span><span class="p"> {</span>
    <span class="c"># send all traffic to the bar director:</span>
    <span class="k">set</span> <span class="nv">req.backend_hint</span> <span class="o">=</span> <span class="nf">bar</span><span class="p">.</span><span class="nf">backend</span><span class="p">();</span>
<span class="o">}</span>
</pre></div>
</div>
<p>This director is a round-robin director. This means the director will distribute
the incoming requests on a round-robin basis. There is also a random director
which distributes requests in a, you guessed it, random fashion. If that is not
enough, you can also write your own director (see Writing a Director).</p>
<p>But what if one of your servers goes down? Can Varnish direct all the requests
to the healthy server? Sure it can. This is where the Health Checks come into
play.</p>
</div>
<div class="section" id="health-checks">
<h2>Health Checks<a class="headerlink" href="#health-checks" title="Permalink to this headline">¶</a></h2>
<p>Lets set up a director with two backends and health checks.
First let us define the backends:</p>
<div class="highlight-VCL"><div class="highlight"><pre><span></span>  <span class="k">backend</span><span class="vg"> server1</span><span class="p"> {</span>
      <span class="na">.host</span><span class="o"> = </span><span class="s">&quot;server1.example.com&quot;</span><span class="p">;</span>
      <span class="na">.probe</span><span class="o"> = </span><span class="p">{</span>
          <span class="na">.url</span><span class="o"> = </span><span class="s">&quot;/&quot;</span><span class="p">;</span>
          <span class="na">.timeout</span><span class="o"> = </span><span class="ld">1s</span><span class="p">;</span>
          <span class="na">.interval</span><span class="o"> = </span><span class="ld">5s</span><span class="p">;</span>
          <span class="na">.window</span><span class="o"> = </span><span class="m">5</span><span class="p">;</span>
          <span class="na">.threshold</span><span class="o"> = </span><span class="m">3</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">backend</span><span class="vg"> server2</span><span class="p"> {</span>
      <span class="na">.host</span><span class="o"> = </span><span class="s">&quot;server2.example.com&quot;</span><span class="p">;</span>
      <span class="na">.probe</span><span class="o"> = </span><span class="p">{</span>
          <span class="na">.url</span><span class="o"> = </span><span class="s">&quot;/&quot;</span><span class="p">;</span>
          <span class="na">.timeout</span><span class="o"> = </span><span class="ld">1s</span><span class="p">;</span>
          <span class="na">.interval</span><span class="o"> = </span><span class="ld">5s</span><span class="p">;</span>
          <span class="na">.window</span><span class="o"> = </span><span class="m">5</span><span class="p">;</span>
          <span class="na">.threshold</span><span class="o"> = </span><span class="m">3</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">}</span>
</pre></div>
</div>
<p>What is new here is the probe.
In this example Varnish will check the health of each backend every 5 seconds,
timing out after 1 second. Each poll will send a GET request to /.
If 3 out of the last 5 polls succeeded the backend is considered healthy,
otherwise it will be marked as sick.</p>
<p>Refer to the Probes section in the VCL documentation for more information.</p>
<p>Now we define the &#8216;director&#8217;:</p>
<div class="highlight-vcl"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="n">directors</span><span class="p">;</span>

<span class="k">sub </span><span class="nf">vcl_init</span><span class="p"> {</span>
    <span class="k">new</span> <span class="n">vdir</span> <span class="o">=</span> <span class="nf">directors</span><span class="p">.</span><span class="nf">round_robin</span><span class="p">();</span>
    <span class="nf">vdir</span><span class="p">.</span><span class="nf">add_backend</span><span class="p">(</span><span class="n">server1</span><span class="p">);</span>
    <span class="nf">vdir</span><span class="p">.</span><span class="nf">add_backend</span><span class="p">(</span><span class="n">server2</span><span class="p">);</span>
<span class="o">}</span>
</pre></div>
</div>
<p>You use this vdir director as a backend_hint for requests, just like you would
with a simple backend. Varnish will not send traffic to hosts that are marked as
unhealthy.</p>
<p>Varnish can also serve stale content if all the backends are down.
See <strong>Misbehaving servers</strong> in the varnish documentation for more information
on how to enable this.</p>
<p>Please note that Varnish will keep health probes running for all loaded VCLs.
Varnish will coalesce probes that seem identical - so be careful not to change
the probe config if you do a lot of VCL loading. Unloading the VCL will discard
the probes.</p>
<p>source and more details <a class="reference external" href="https://www.varnish-cache.org/docs/trunk/users-guide/vcl-backends.html?highlight=multiple%20varnish">here</a> .</p>
</div>
</div>


</div>

<br/>

<div class="container">
	<div class="footer">
		<div class="text-muted text-center">
			<small>Copyright 2018, Varnish Software AB</small>
		</div>
		<div class="text-muted text-center">
			<small>®Varnish Software, Norrtullsgatan 6, 113 29 Stockholm, Organization nr. 556805-6203</small>
		</div>
	</div>
</div>

<script async src="https:////radar.cedexis.com/1/20516/radar.js"></script>

</body>
</html>