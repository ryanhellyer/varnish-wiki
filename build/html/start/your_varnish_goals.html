

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<title>What do you want to achieve with Varnish? &mdash; Varnish Wiki  documentation</title>
	

	
	

	

	<script type="text/javascript">
		var DOCUMENTATION_OPTIONS = {
			URL_ROOT:       './',
			VERSION:        '1.0',
			COLLAPSE_INDEX: false,
			FILE_SUFFIX:    '.html',
			HAS_SOURCE:     true
		};
	</script>
	<script type="text/javascript" src="https://www.varnish-software.com//wiki/_static/jquery.js"></script>
	<script type="text/javascript" src="https://www.varnish-software.com//wiki/_static/underscore.js"></script>
	<script type="text/javascript" src="https://www.varnish-software.com//wiki/_static/doctools.js"></script>
	<script type="text/javascript" src="https://www.varnish-software.com//wiki/_static/searchtools.js"></script>
	<script type="text/javascript" src="https://www.varnish-software.com//wiki/_static/js/jquery-1.11.0.min.js"></script>
	<script type="text/javascript" src="https://www.varnish-software.com//wiki/_static/js/jquery-fix.js"></script>
	<link rel="search" title="Search" href="#" />
	<script type="text/javascript">jQuery(function() { Search.loadIndex("searchindex.js"); });</script>
	<script type="text/javascript" id="searchindexloader"></script>
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-15491050-1']);
		_gaq.push(['_trackPageview']);
		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>

	<link rel="stylesheet" href="../_static/default.css"/>
	<link rel="stylesheet" href="../_static/custom.css"/>

	<script src="../_static/js/popper.min.js"></script>
	<script src="../_static/js/bootstrap.min.js"></script>
	<link href="../_static/css/bootstrap.min.css" rel="stylesheet">
	<link href="../_static/css/font-awesome.min.css" rel="stylesheet">
	<link href="../_static/css/custom.css" rel="stylesheet">
	<link href="../_static/css/prism.css" rel="stylesheet">
	<link rel="icon" type="image/png" href="../_static/images/favicon.png">

	
	<script src="../_static/js/modernizr.min.js"></script></head>
<body>

<div class="container">
	<a href="https://www.varnish-software.com/">
		<img class="logo" src="../_static/images/varnish_software_logo.png" />
	</a>

	<hr />
</div>
<div class="container">

	

	<div id="wiki-sidebar">
		<div class="sidebar-block">
			<div class="sidebar-wrapper">
				<h3>Contents</h3>
			<div class="sidebar-localtoc">
				<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Getting Started</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">What do you want to achieve with Varnish?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#achieving-a-high-hit-rate">Achieving a High Hit rate!</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#varnishtop">varnishtop</a></li>
<li class="toctree-l4"><a class="reference internal" href="#varnishlog">varnishlog</a></li>
<li class="toctree-l4"><a class="reference internal" href="#http-request">HTTP Request</a></li>
<li class="toctree-l4"><a class="reference internal" href="#note-on-http-2-and-tls-ssl-in-varnish">Note on HTTP/2 and TLS/SSL in Varnish</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#managing-your-cookies">Managing Your Cookies!</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#cookies-from-the-client">Cookies from the Client</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cookies-from-the-backend">Cookies from the Backend</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-age-header">The Age Header</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pragma">Pragma</a></li>
<li class="toctree-l4"><a class="reference internal" href="#overriding-the-ttl">Overriding the TTL</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#http-vary">HTTP Vary</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compression">Compression!</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-default-compression-behavior">The Default Compression Behavior</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compressing-content-if-backends-don-t">Compressing Content If Backends Don&#8217;t</a></li>
<li class="toctree-l4"><a class="reference internal" href="#decompressing-content-before-sending-to-cache">Decompressing Content before Sending to Cache</a></li>
<li class="toctree-l4"><a class="reference internal" href="#gzip-and-esi">GZIP and ESI</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#purging-and-banning">Purging and Banning!</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#http-purging">HTTP Purging</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bans">Bans</a></li>
<li class="toctree-l4"><a class="reference internal" href="#forcing-a-cache-miss">Forcing a Cache Miss</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#per-object-cache-invalidation">Per Object Cache Invalidation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#flushing-the-entire-cache">Flushing the Entire Cache</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#varnishtest">Varnishtest</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#useful-links-on-this-topic">Useful links on this topic</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="website_arch.html">Understanding a Typical Website Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="httpcaching_basics.html">Basic HTTP Caching</a></li>
<li class="toctree-l2"><a class="reference internal" href="webTerms.html">Web caching Terminologies</a></li>
<li class="toctree-l2"><a class="reference internal" href="webTerms.html#varnish-three-letter-acronyms">Varnish Three Letter Acronyms</a></li>
<li class="toctree-l2"><a class="reference internal" href="general_resources.html">Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#installing-and-configuring-varnish">Installing and Configuring Varnish</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#step-by-step-configuration-for-web-applications">Step-by-Step Configuration for Web Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#configuration-for-enterprise-products">Configuration for Enterprise Products</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#configuring-vcl-beyond-the-default">Configuring VCL Beyond the Default</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#recipes-for-cache-invalidation">Recipes for Cache Invalidation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">Varnish Web Developer&#8217;s FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/tutorials/varnish/index.html">How to Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/tutorials/wordpress/index.html">WordPress with Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/tutorials/magento2/index.html">Magento2 with Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/tutorials/drupal/index.html">Drupal with Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/tutorials/aem.html">Adobe Experience Manager and Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/tutorials/expressionEngine.html">ExpressionEngine and Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/tutorials/sitecoreCMS.html">Sitecore CMS and Varnish</a></li>
</ul>

			</div>
		</div>
	</div>

	
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="../search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
	
  <div class="sidebar-block">
    <div class="sidebar-wrapper">
      <h4>&nbsp;&nbsp;Contribute</h4>
      <ul class="this-page-menu">
        <li><a href="../_sources/start/your_varnish_goals.txt"
               rel="nofollow">Show Source</a></li>
        <li><a href="https://github.com/huayra/wiki_varnish/blob/master/source/start/your_varnish_goals.rst"
               rel="nofollow">Show on GitHub</a></li>
        <li><a href="https://github.com/huayra/wiki_varnish/edit/master/source/start/your_varnish_goals.rst"
               rel="nofollow">Edit on GitHub</a></li>
      </ul>
    </div>
  </div>
</div>


<div id="wiki-content">
	
  <div class="section" id="what-do-you-want-to-achieve-with-varnish">
<span id="your-varnish-goals"></span><h1>What do you want to achieve with Varnish?<a class="headerlink" href="#what-do-you-want-to-achieve-with-varnish" title="Permalink to this headline">Â¶</a></h1>
<p>Once Varnish is up and running, you can do quite a lot of different things.
The three most common features for which Varnish is best known are caching, cache
invalidation and load balancing. Many other services and features can be provided by Varnish
to enhance this experience for clients and the service providers.</p>
<p>This section of our wiki is all about:</p>
<ul class="simple">
<li>The performance of your Varnish server</li>
<li>Fine tuning the performance of your website using Varnish</li>
<li>Compressing your web content</li>
</ul>
<p>You can read in greater detail on the <a class="reference external" href="https://www.varnish-cache.org/docs/4.1/users-guide/performance.html#users-performance">varnish-cache.org</a> site.</p>
<div class="section" id="achieving-a-high-hit-rate">
<span id="achieve-high-hitrate"></span><h2>Achieving a High Hit rate!<a class="headerlink" href="#achieving-a-high-hit-rate" title="Permalink to this headline">Â¶</a></h2>
<blockquote>
<div>To understand your Varnish set-up better and be able to manage it, there are
quite a few tools that Varnish provides.</div></blockquote>
<div class="section" id="varnishtop">
<h3><a class="reference external" href="https://www.varnish-cache.org/docs/4.1/reference/varnishtop.html#varnishtop-1">varnishtop</a><a class="headerlink" href="#varnishtop" title="Permalink to this headline">Â¶</a></h3>
<p>This tool reads the shared memory logs and continuously presents an updated list
of commonly occurring entries. This can help you identify requested documents,
clients, URLs, user agents, etc. - essentially whatever requests are hitting the backend the most.</p>
<p>To see the top requests sent to the backend use:</p>
<div class="highlight-VCL"><div class="highlight"><pre><span></span><span class="n">varnishtop</span> <span class="o">-</span><span class="n">i</span> <span class="n">BereqURL</span>
</pre></div>
</div>
<p>To see which URLs the client is requesting:</p>
<div class="highlight-VCL"><div class="highlight"><pre><span></span><span class="n">varnishtop</span> <span class="o">-</span><span class="n">i</span> <span class="n">ReqURL</span>
</pre></div>
</div>
<p>To see the most popular Accept-encoding header the client is sending:</p>
<div class="highlight-VCL"><div class="highlight"><pre><span></span>varnishtop -I ReqHeader:Accept-Encoding
</pre></div>
</div>
</div>
<div class="section" id="varnishlog">
<h3><a class="reference external" href="https://www.varnish-cache.org/docs/4.1/reference/varnishlog.html#varnishlog-1">varnishlog</a><a class="headerlink" href="#varnishlog" title="Permalink to this headline">Â¶</a></h3>
<p>This tool can help you get an inside look at the requests. The way the Varnish
log works is amazing. It is designed to store its logs in a shared memory segment
called Varnish Shared Log (VSL). This memory segment size is fixed, so that once the
segment is full, data is overwritten. If you really want certain logs to be
stored, you need to tell another program to do that for you. If you forget to do that,
your data might be overwritten.</p>
<p>This has its advantage as it saves memory and only saves logs that you require.</p>
<p>Using the command, <cite>varnishlog</cite> provides raw logs.</p>
<p>To see running processes type:</p>
<div class="highlight-VCL"><div class="highlight"><pre><span></span><span class="n">varnishlog</span> <span class="o">-</span><span class="n">g</span> <span class="n">raw</span>
</pre></div>
</div>
<p>It shows Varnish master process checking up on the caching process.</p>
<p>Go here to understand <a class="reference external" href="http://vsltrans.varnish.jp/">Varnishlog in Human Language</a> .
Here is the source code for <a class="reference external" href="https://github.com/xcir/vsltrans">vsltrans</a></p>
</div>
<div class="section" id="http-request">
<h3>HTTP Request<a class="headerlink" href="#http-request" title="Permalink to this headline">Â¶</a></h3>
<p>There are lots of tools out there that can execute HTTP requests and return very
useful information. Some of the tools are GET, Seige, HTTPie, etc.</p>
<p>Varnish only cares about the headers. A request sent like the following will
return header information.</p>
<p>To see header information of a site, try:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>http -i http://yourvarnishsite.com/
</pre></div>
</div>
<p>This will return information on the HTTP header being passed.</p>
<p>To check whether a site sets cookies for a specific URL try:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>GET -Used http://yourvarnishsite.com/ <span class="p">|</span> grep ^Set-Cookie
</pre></div>
</div>
</div>
<div class="section" id="note-on-http-2-and-tls-ssl-in-varnish">
<h3>Note on HTTP/2 and TLS/SSL in Varnish<a class="headerlink" href="#note-on-http-2-and-tls-ssl-in-varnish" title="Permalink to this headline">Â¶</a></h3>
<p>Although Varnish itself does not yet support HTTPS we recommend you use
<a class="reference external" href="http://hitch-tls.org/">Hitch 1.4</a> or later for TLS/SSL Termination.</p>
<p>As for HTTP/2 support, most browsers support it only with TLS. For this
you will need <a class="reference external" href="http://hitch-tls.org/">Hitch 1.4</a> and Varnish 5.0 or later. You can read about
<a class="reference external" href="https://info.varnish-software.com/blog/varnish-cache-5-http2-support">How to get started with Varnish Cache 5.0 with experimental HTTP/2 support</a>
in our blog.</p>
</div>
</div>
<div class="section" id="managing-your-cookies">
<h2>Managing Your Cookies!<a class="headerlink" href="#managing-your-cookies" title="Permalink to this headline">Â¶</a></h2>
<p>As you have already seen above, with each HTTP request there are many cookies,
i.e. headers carrying metadata. One of the things Varnish has to do is check these
headers to identify their appropriateness for caching. If you read about the
<cite>ROLE of HTTP Headers</cite> on the Varnish Cache site, then you probably have read,
&#8220;Please note that when Varnish considers these headers Varnish actually considers
itself part of the actual webserver.&#8221;</p>
<p>So the most important cookies that you should have a look at include:</p>
<div class="section" id="cookies-from-the-client">
<h3>Cookies from the Client<a class="headerlink" href="#cookies-from-the-client" title="Permalink to this headline">Â¶</a></h3>
<p>A piece of code like the following will disregard cookies from login pages:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp"># include this snippet as part of the vcl_recv in the defaut.vcl file</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">url</span> <span class="o">~</span> <span class="s">&quot;^/login/&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">unset</span> <span class="n">req</span><span class="p">.</span><span class="n">http</span><span class="p">.</span><span class="n">Cookie</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li>Disregarding graphical files</li>
</ul>
<p>This code is an example of how to disregard all cookies related to CSS files, such as
stylesheets and graphics.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#vA vcl snippet to remove css cookeis from headers.</span>
</pre></div>
</div>
<p>Another great example of using regular expressions to check your cookies:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># a vcl snippet as part of the vcl_recv</span>
<span class="c1"># this helps in removing everythign except a few cookies.</span>
<span class="c1"># exapmple collected from the varnish.cache site.</span>

<span class="n">sub</span> <span class="n">vcl_recv</span>Â <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">Cookie</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">set</span> <span class="n">req</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">Cookie</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span> <span class="o">+</span> <span class="n">req</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">Cookie</span><span class="p">;</span>
    <span class="nb">set</span> <span class="n">req</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">Cookie</span> <span class="o">=</span> <span class="n">regsuball</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">HTTP</span><span class="o">.</span><span class="n">Cookie</span><span class="p">,</span> <span class="s2">&quot;; +&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">);</span>
    <span class="nb">set</span> <span class="n">req</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">Cookie</span> <span class="o">=</span> <span class="n">regsuball</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">HTTP</span><span class="o">.</span><span class="n">Cookie</span><span class="p">,</span> <span class="s2">&quot;;(COOKIE1|COOKIE2)=&quot;</span><span class="p">,</span> <span class="s2">&quot;; </span><span class="se">\1</span><span class="s2">=&quot;</span><span class="p">);</span>
    <span class="nb">set</span> <span class="n">req</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">Cookie</span> <span class="o">=</span> <span class="n">regsuball</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">HTTP</span><span class="o">.</span><span class="n">Cookie</span><span class="p">,</span> <span class="s2">&quot;[^ ][^;]*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="nb">set</span> <span class="n">req</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">Cookie</span> <span class="o">=</span> <span class="n">regsuball</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">HTTP</span><span class="o">.</span><span class="n">Cookie</span><span class="p">,</span> <span class="s2">&quot;^[; ]+|[; ]+$ &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="c1"># The snippet below does the opposite. picks out the one cookie to be cached</span>

<span class="n">sub</span> <span class="n">vcl_recv</span> <span class="p">{</span>
    <span class="c1"># save the original cookie header so we can mangle it</span>
    <span class="nb">set</span> <span class="n">req</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">X</span><span class="o">-</span><span class="n">Varnish</span><span class="o">-</span><span class="n">PHP_SID</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">Cookie</span><span class="p">;</span>
    <span class="c1"># using a capturing sub pattern, extract the continuous string of</span>
    <span class="c1"># alphanumerics that immediately follows &quot;PHPSESSID=&quot;</span>
    <span class="nb">set</span> <span class="n">req</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">X</span><span class="o">-</span><span class="n">Varnish</span><span class="o">-</span><span class="n">PHP_SID</span> <span class="o">=</span>
       <span class="n">regsuball</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">X</span><span class="o">-</span><span class="n">Varnish</span><span class="o">-</span><span class="n">PHP_SID</span><span class="p">,</span> <span class="s2">&quot;;? ?PHPSESSID=([a-zA-Z0-9]+)( |;| ;).*&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\1</span><span class="s2">&quot;</span><span class="p">);</span>
    <span class="nb">set</span> <span class="n">req</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">Cookie</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">X</span><span class="o">-</span><span class="n">Varnish</span><span class="o">-</span><span class="n">PHP_SID</span><span class="p">;</span>
    <span class="n">unset</span> <span class="n">req</span><span class="o">.</span><span class="n">X</span><span class="o">-</span><span class="n">Varnish</span><span class="o">-</span><span class="n">PHP_SID</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1"># collected from https://www.varnish-cache.org/docs/4.1/users-guide/increasing-your-hitrate.html</span>
</pre></div>
</div>
</div>
<div class="section" id="cookies-from-the-backend">
<h3>Cookies from the Backend<a class="headerlink" href="#cookies-from-the-backend" title="Permalink to this headline">Â¶</a></h3>
<p>If you have set a cookie using the &#8216;Set-Cookie&#8217; header as shown in the previous example,
Varnish will not cache the page when using the default configuration. Instead it
will create a <cite>hit-for-pass</cite> object.</p>
<p>In such a case if the backend server ends up caching unnecessary cookies, just
unset the Set-Cookie header as shown in the example below.</p>
<div class="highlight-VCL"><div class="highlight"><pre><span></span><span class="nf">vcl_recv</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="k">unset</span> <span class="nv">req.http.Set-Cookie</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="the-age-header">
<h3>The Age Header<a class="headerlink" href="#the-age-header" title="Permalink to this headline">Â¶</a></h3>
<p>To understand how long an object can be kept in Varnish Cache, there is an Age
header, which is set through the default.vcl file and the value can be viewed by
collecting the Age header from the request header as shown below:</p>
<div class="highlight-VCL"><div class="highlight"><pre><span></span>varnishlog -I ReqHrader:^Age
</pre></div>
</div>
</div>
<div class="section" id="pragma">
<h3>Pragma<a class="headerlink" href="#pragma" title="Permalink to this headline">Â¶</a></h3>
<p>Some web applications require request directives on how to process their input.
An example could be that the server sent a header such as <cite>Pragma: nocache</cite>,
then varnish will ignore this header. To support this header, a VCL snippet like
the one below could be added to the vcl_backend_response to add support for that
header in the VCL:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">beresp</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">Pragma</span> <span class="o">~</span> <span class="s2">&quot;nocache&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">set</span> <span class="n">beresp</span><span class="o">.</span><span class="n">uncacheable</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
    <span class="nb">set</span> <span class="n">beresp</span><span class="o">.</span><span class="n">ttl</span> <span class="o">=</span> <span class="mi">120</span><span class="n">s</span><span class="p">;</span> <span class="c1"># how long not to cache this url.</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="overriding-the-ttl">
<h3>Overriding the TTL<a class="headerlink" href="#overriding-the-ttl" title="Permalink to this headline">Â¶</a></h3>
<p>You will find that there are multiple variables available in the <cite>vcl_backend_response</cite>.
The one we are concerned about here is the <cite>beresp.ttl</cite>, which defines how long the
object is kept in cache. This <cite>vcl_backened_fetch</cite> function is the backend connection
to Varnish&#8217;s frontend through the subroutine <cite>vcl_recv</cite>.</p>
<p>When a request is passed with <cite>pass</cite> from vcl_recv, the object does not go to
the backend without typically being altered by the <cite>vcl_backened_fetch</cite>. In this
subroutine even if a cache time is defined, the <cite>vcl_backened_response</cite>
logic is still executed.</p>
<p>So if you read the VCL Basics chapter in the <a class="reference external" href="https://book.varnish-software.com">Varnish Book</a> you will learn that
if the request was not passed before reaching the <cite>vcl_backend_response</cite>, the
<cite>beresp.ttl</cite> is still used even when you perform a hit_for_pass in
<cite>vcl_backend_response</cite>. When you perform a pass in vcl_fetch you cache the decision
you made. In other words: If beresp.ttl is set to 7 days as shown in the example
and you issue a pass, the object will be recorded in the cache and remain there
for 5 days, telling Varnish not to cache.</p>
<p>Therefore sometimes overriding the default TTL value can really help resolve
backend problems.</p>
<p>A simple example would be to directly set the beresp.ttl in vcl_backend_response
to a sensible value.</p>
<div class="highlight-VCL"><div class="highlight"><pre><span></span><span class="k">sub </span><span class="nf">vcl_backend_response</span><span class="p"> {</span>
          <span class="k">set</span> <span class="nv">beresp.ttl</span> <span class="o">=</span> <span class="m">7</span> <span class="n">d</span><span class="p">;</span> <span class="c"># 7 days</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The example below shows the beresp-ttl value set to 5 days, which means that the URL
will be stored in cache for 7 days and Varnish will not cache it for 7 days.</p>
<div class="highlight-VCL"><div class="highlight"><pre><span></span><span class="k">sub </span><span class="nf">vcl_backend_response</span><span class="p"> {</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">bereq.url</span> <span class="o">~</span> <span class="s">&quot;^/legacy_broken_cms/&quot;</span><span class="p">)</span> <span class="o">{</span>
          <span class="k">set</span> <span class="nv">beresp.ttl</span> <span class="o">=</span> <span class="m">7</span> <span class="n">d</span><span class="p">;</span>
      <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="http-vary">
<h2>HTTP Vary<a class="headerlink" href="#http-vary" title="Permalink to this headline">Â¶</a></h2>
<p>The HTTP Vary header is the most insane and not-well-understood header on the internet.
But the HTTP Vary header is used for caching, so in order to cache it is advised
to understand it. It is also capable of doing many other wonderful things.</p>
<p><strong>Warning</strong></p>
<p>Varnish does not necessarily understand the semantics of a header, or
what part triggers different variants of a response. In other words, an
inappropriate use of Vary might create a very large number of cached objects,
and reduce the efficiency of your cache server. Therefore, you must be extremely
cautious when using Vary.</p>
<p>In Varnish the vary response header can be used to store responses that are based
on the value of cookies.</p>
<p>Refer to <cite>Header Field Definitions, section 14.44</cite> to understand Vary better.</p>
<p>As you may already know, the URL can be used as a parameter by Varnish for caching
purposes. Also it is possible to add custom header values to hash in the <cite>vcl_hash</cite>
subroutine. So in this context if you want your cache to be based on headers, you
can set the Vary header to various types: cookies, Accept-Encoding, X-Varnish,
User-Agent, Accept-Language, etc.</p>
<p>This way, different values of your custom header will have different hash values
for each cached resource. But remember that variations containing the Vary response
header share the same hash value.</p>
<p>An example would be when servers issue a <cite>Vary: Accept-Encoding</cite> (it is the most
common usage of Vary) it tells Varnish that it needs to cache a separate version
for every different Accept-Encoding that is coming from the different clients.</p>
<p>This could lower your server&#8217;s performance but enhance user experience.</p>
<p>But this could also lead to Varnish caching a whole bunch of different types of
headers and reducing efficiency and performance as a whole. Normalizing the
accept-encoding header ensures that this problem is solved by storing the fewest variants
possible.</p>
<p>The following VCL code shows how to normalize the Accept-Encoding headers:</p>
<div class="highlight-VCL"><div class="highlight"><pre><span></span><span class="c"># Ths code sets the Accept-Encoding header from the client to either gzip, deflate with a preference for gzip.</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">req.http.Accept-Encoding</span><span class="p">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">req.url</span> <span class="o">~</span> <span class="s">&quot;\.(jpg|png|gif|gz|tgz|bz2|tbz|mp3|ogg)&quot;</span><span class="p">)</span> <span class="o">{</span>
        <span class="c"># No point in compressing these</span>
        <span class="n">remove</span> <span class="nv">req.http.Accept-Encoding</span><span class="p">;</span>
    <span class="o">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">req.http.Accept-Encoding</span> <span class="o">~</span> <span class="s">&quot;gzip&quot;</span><span class="p">)</span> <span class="o">{</span>
        <span class="k">set</span> <span class="nv">req.http.Accept-Encoding</span> <span class="o">=</span> <span class="s">&quot;gzip&quot;</span><span class="p">;</span>
    <span class="o">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">req.http.Accept-Encoding</span> <span class="o">~</span> <span class="s">&quot;deflate&quot;</span><span class="p">)</span> <span class="o">{</span>
        <span class="k">set</span> <span class="nv">req.http.Accept-Encoding</span> <span class="o">=</span> <span class="s">&quot;deflate&quot;</span><span class="p">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c"># unknown algorithm</span>
        <span class="n">remove</span> <span class="nv">req.http.Accept-Encoding</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Another example for normalizing <cite>Accept-Language</cite> header:</p>
<div class="highlight-VCL"><div class="highlight"><pre><span></span><span class="c"># Normalize Accept-Language</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">req.http.Accept-Language</span><span class="p">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">req.http.Accept-Language</span> <span class="o">~</span> <span class="s">&quot;en&quot;</span><span class="p">)</span> <span class="o">{</span>
        <span class="k">set</span> <span class="nv">req.http.Accept-Language</span> <span class="o">=</span> <span class="s">&quot;en&quot;</span><span class="p">;</span>
    <span class="o">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">req.http.Accept-Language</span> <span class="o">~</span> <span class="s">&quot;de&quot;</span><span class="p">)</span> <span class="o">{</span>
        <span class="k">set</span> <span class="nv">req.http.Accept-Language</span> <span class="o">=</span> <span class="s">&quot;de&quot;</span><span class="p">;</span>
    <span class="o">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">req.http.Accept-Language</span> <span class="o">~</span> <span class="s">&quot;fr&quot;</span><span class="p">)</span> <span class="o">{</span>
        <span class="k">set</span> <span class="nv">req.http.Accept-Language</span> <span class="o">=</span> <span class="s">&quot;fr&quot;</span><span class="p">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c"># unknown language. Remove the accept-language header and</span>
        <span class="c"># use the backend default.</span>
        <span class="k">unset</span> <span class="nv">req.http.Accept-Language</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>One of the best ways to take advantage of Vary would be to build the response
header based on cached and non-cached objects. This brings us to the next topic:
Compression!</p>
<p>Note: Some application servers send Vary with User-Agent. This, as you can tell,
orders Varnish to cache a separate copy for every variant client/user-agent there
is. This could be a disaster depending on the number of variation of clients you
serve on a regular basis.</p>
</div>
<div class="section" id="compression">
<h2>Compression!<a class="headerlink" href="#compression" title="Permalink to this headline">Â¶</a></h2>
<p>Does Varnish compress objects? As of Varnish 4.0 the default is set to compression
&#8220;ON&#8221;. You can always turn it off. Have a look at the <a class="reference external" href="https://www.varnish-cache.org/docs/4.1/reference/varnishd.html#varnishd-1">Reference Guide</a>.</p>
<div class="section" id="the-default-compression-behavior">
<h3>The Default Compression Behavior<a class="headerlink" href="#the-default-compression-behavior" title="Permalink to this headline">Â¶</a></h3>
<p>Compression is on when you see:</p>
<p>The <cite>http_gzip_support = on</cite>
And beresp.do_gzip and beresp.do_gunzip are NOT used in VCL.</p>
<p><em>Unless</em> while returning from <cite>vcl_recv</cite> with <cite>pipe</cite> or <cite>pass</cite>, Varnish modifies
<cite>req-http-Encoding</cite> that is say, the <cite>req.http.Accept-Encoding</cite> is set to &#8220;gzip&#8221;
that means this client supports compressed content.</p>
<p><em>Also note</em> that if <cite>http_gzip_support</cite> parameter is set to <cite>off</cite>, Varnish will
not alter any headers and if there is a <cite>Vary: Accept-Encoding</cite> set it will deal
with it normally just as explained under HTTP_Vary.</p>
</div>
<div class="section" id="compressing-content-if-backends-don-t">
<h3>Compressing Content If Backends Don&#8217;t<a class="headerlink" href="#compressing-content-if-backends-don-t" title="Permalink to this headline">Â¶</a></h3>
<p>If the backend is not compressing content, you can tell Varnish to compress the
content before storing it in cache by appending <cite>beresp.do_gzip = true</cite> in the
<cite>vcl_backend_response</cite> as shown below.</p>
<div class="highlight-VCL"><div class="highlight"><pre><span></span><span class="k">sub </span><span class="nf">vcl_backend_response</span><span class="p"> {</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">beresp.http.content-type</span> <span class="o">~</span> <span class="s">&quot;text&quot;</span><span class="p">)</span> <span class="o">{</span>
        <span class="k">set</span> <span class="nv">beresp.do_gzip</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>This code will make the following changes to the object header before inserting
in cache:</p>
<ul class="simple">
<li>set <cite>object.http.Content-Encoding</cite> to <cite>gzip</cite></li>
<li>add <cite>Accept-Encoding</cite> to <cite>obj.http.Vary</cite></li>
<li>Weaken <cite>Etag</cite></li>
</ul>
<p>Note: Don&#8217;t try to compress content that is noncompressible.</p>
</div>
<div class="section" id="decompressing-content-before-sending-to-cache">
<h3>Decompressing Content before Sending to Cache<a class="headerlink" href="#decompressing-content-before-sending-to-cache" title="Permalink to this headline">Â¶</a></h3>
<p>To decompress content before entering cache, you can tell Varnish to decompress
the content before sending it into cache by appending <cite>beresp.do_gunzip = true</cite>
in the <cite>vcl_backend_response</cite> as shown below.</p>
<div class="highlight-VCL"><div class="highlight"><pre><span></span><span class="k">sub </span><span class="nf">vcl_backend_response</span><span class="p"> {</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">beresp.http.content-type</span> <span class="o">~</span> <span class="s">&quot;text&quot;</span><span class="p">)</span> <span class="o">{</span>
        <span class="k">set</span> <span class="nv">beresp.do_gunzip</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>This makes the following changes to the object header before inserting in cache:</p>
<ul class="simple">
<li>removes <cite>obj.http.Content-Encoding</cite></li>
<li>weaken any Etag (by prepending &#8220;W/&#8221;)</li>
</ul>
</div>
<div class="section" id="gzip-and-esi">
<h3>GZIP and ESI<a class="headerlink" href="#gzip-and-esi" title="Permalink to this headline">Â¶</a></h3>
<p>If you intend to use or are using Edge Side Includes (ESI) you should be aware that ESI
and GZIP work together very well. Varnish will do the decompression of content
for you and recompress it for efficient storage and delivery.</p>
<p>You can read more about <a class="reference external" href="https://www.varnish-cache.org/docs/trunk/phk/gzip.html#phk-gzip">GZIP+ESI</a> with Varnish on the Varnish Cache site.</p>
<p>An FAQ on compression: <a class="reference external" href="https://varnish-cache.org/docs/2.1/faq/http.html">https://varnish-cache.org/docs/2.1/faq/http.html</a></p>
</div>
</div>
<div class="section" id="purging-and-banning">
<h2>Purging and Banning!<a class="headerlink" href="#purging-and-banning" title="Permalink to this headline">Â¶</a></h2>
<p>One of the most widely used methods of increasing hit-ratio (which is mentioned
many times on this website) is by increasing the time-to-live (TTL) of the object.</p>
<p>But as you know, in this era serving outdated content/stale data is like
serving rotten food that no one will eat.</p>
<p>The solution to this problem is to have a mechanism that will notify Varnish
whenever there is fresh content. There are three mechanisms to achieve this:</p>
<ul class="simple">
<li>HTTP Purging</li>
<li>Bans</li>
<li>Forcing a cache miss</li>
</ul>
<div class="section" id="http-purging">
<h3>HTTP Purging<a class="headerlink" href="#http-purging" title="Permalink to this headline">Â¶</a></h3>
<p>An HTTP purge is very much like a HTTP request except it does something different.</p>
<p>Purging is when an object is requested from cache and is then discarded. This
means that every time there is fresh data for an object, that object is requested and
<cite>purged</cite>. The simplest way to achieve this is by using the code given below:</p>
<div class="highlight-VCL"><div class="highlight"><pre><span></span><span class="k">acl </span><span class="vg">purge </span><span class="p">{</span>
        <span class="s">&quot;localhost&quot;</span><span class="p">;</span>
        <span class="s">&quot;x.x.x.x&quot;</span><span class="o">/</span><span class="m">24</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">vcl_recv</span><span class="p"> {</span>
        <span class="c"># this code below allows PURGE from localhost and x.x.x.x</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">req.method</span> <span class="o">==</span> <span class="s">&quot;PURGE&quot;</span><span class="p">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">client.ip</span> <span class="o">~</span> <span class="no">purge</span><span class="p">)</span> <span class="o">{</span>
                        <span class="k">return</span><span class="p">(</span><span class="no">synth</span><span class="p">(</span><span class="m">405</span><span class="o">,</span><span class="s">&quot;Not allowed.&quot;</span><span class="p">));</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="p">(</span><span class="no">purge</span><span class="p">);</span>
        <span class="o">}</span>
<span class="o">}</span>

<span class="c"># Notice the return (purge) this means that this subroutine will end here and</span>
<span class="c"># jump to the next sub routine vcl_hash without appending to the built-in vcl_recv</span>
<span class="c"># To read more on this go to https://www.varnish-cache.org/docs/trunk/users-guide/purging.html</span>
</pre></div>
</div>
</div>
<div class="section" id="bans">
<h3>Bans<a class="headerlink" href="#bans" title="Permalink to this headline">Â¶</a></h3>
<p>Bans can be implemented for objects that are known to frequently change.
In such a case, certain content is banned from being retrieved from the cache based
on the metadata. The ban is quite a reliable method, as it only works for objects
in the cache but does not interfere with new content being cached or served.</p>
<p>Support for bans is built into Varnish and it is available from the CLI.</p>
<p>For example to ban every jpeg and png object from caching, you can try the
following example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1">#banning images with png and jpeg extension</span>

<span class="n">sub</span> <span class="n">vcl_recv</span><span class="p">{</span>

  <span class="n">ban</span> <span class="n">req</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">host</span> <span class="o">==</span> <span class="s2">&quot;example.com&quot;</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">.</span><span class="n">url</span> <span class="o">~</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">.png$&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Another example of a ban:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span># banning certain URLs

sub vcl_recv {
        if (req.method == &quot;BAN&quot;) {
                # Same ACL check as above:
                if (!client.ip ~ purge) {
                        return(synth(403, &quot;Not allowed.&quot;));
                }
                ban(&quot;req.http.host == &quot; + req.http.host +
                      &quot; &amp;&amp; req.url == &quot; + req.url);

                # Throw a synthetic page so the
                # request won&#39;t go to the backend.
                return(synth(200, &quot;Ban added&quot;));
        }
}


# reference : https://www.varnish-cache.org/docs/trunk/users-guide/purging.html
</pre></div>
</div>
</div>
<div class="section" id="forcing-a-cache-miss">
<h3>Forcing a Cache Miss<a class="headerlink" href="#forcing-a-cache-miss" title="Permalink to this headline">Â¶</a></h3>
<p>This mechanism is similar to flushing the entire cache, in that it follows the
procedure that when an object is not found in the cache it is served from the
backend. But it is also very much like bans. However a cache miss is more reliable as
this is forced and very much like refreshing a page. This method refreshes an
object by forcing a cache miss for a request, thus enabling a force fetch from the
backend and overriding the current one. But the old object does remain in the cache
until its TTL expires. The aforementioned methods have their subroutines pre-written
in the <code class="docutils literal"><span class="pre">/etc/varnish/default.vcl</span></code> i.e.`req.hash_always_miss` in <cite>vcl_recv</cite> and
can be configured and used as required.</p>
</div>
</div>
<div class="section" id="per-object-cache-invalidation">
<h2>Per Object Cache Invalidation<a class="headerlink" href="#per-object-cache-invalidation" title="Permalink to this headline">Â¶</a></h2>
<p>Per object cache invalidation is something you want to use if you want to specify
individual objects for caching. This requires a detailed understanding of objects
and cache invalidation.</p>
<p>Say for example, if you want to invalidate selected objects but can determine
which objects viewers have requested and invalidate only those objects.</p>
</div>
<div class="section" id="flushing-the-entire-cache">
<h2>Flushing the Entire Cache<a class="headerlink" href="#flushing-the-entire-cache" title="Permalink to this headline">Â¶</a></h2>
<p>One of the ways some people prefer to do cache invalidation is by flushing the
entire cache, thus forcing Varnish to fetch from the backend. This helps in re-filling
the cache with fresh content. This could be scripted to take place several times
an hour based on the number of changes made on the website. It is important to keep in mind
that if a huge number of changes is made in a short time, this mechanism could slow down
the response rate, as Varnish will be visiting the backend more often.</p>
<p>This is obviously not a recommended method for everyday use. But flushing the whole
cache sometimes doesn&#8217;t hurt.</p>
<div class="section" id="varnishtest">
<h3>Varnishtest<a class="headerlink" href="#varnishtest" title="Permalink to this headline">Â¶</a></h3>
<p>Last but not the least, use varnishtest to test your policies
before running them in production. Use the <a class="reference external" href="https://github.com/xcir/vtctrans">vtctrans</a> if you need help reading the
verbose output.</p>
</div>
</div>
<div class="section" id="useful-links-on-this-topic">
<h2>Useful links on this topic<a class="headerlink" href="#useful-links-on-this-topic" title="Permalink to this headline">Â¶</a></h2>
<p><a class="reference external" href="https://ffwagency.com/blog/varnish-tips-and-tricks">Varnish Tips and Tricks</a></p>
</div>
</div>


</div>

<br/>

<div class="container">
	<div class="footer">
		<div class="text-muted text-center">
			<small>Copyright 2018, Varnish Software AB</small>
		</div>
		<div class="text-muted text-center">
			<small>Â®Varnish Software, Norrtullsgatan 6, 113 29 Stockholm, Organization nr. 556805-6203</small>
		</div>
	</div>
</div>

<script async src="https:////radar.cedexis.com/1/20516/radar.js"></script>

</body>
</html>